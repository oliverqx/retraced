ARG NODEJS_IMAGE=node:18.15.0-alpine3.17
ARG ALPINE_IMAGE=alpine:3.17

# # #
# Node build
#
FROM --platform=${BUILDPLATFORM:-linux/amd64} $NODEJS_IMAGE as node

#python
RUN apk add --no-cache --virtual .gyp \
  python3 \
  make \
  g++

WORKDIR /src
ADD package.json /src
ADD package-lock.json /src
RUN npm install

ADD . /src

RUN npm run build

# # #
# Main build
#
FROM $NODEJS_IMAGE

EXPOSE 3000

WORKDIR /app

RUN apk add --update --no-cache ca-certificates curl p11-kit \
  && rm -rf /tmp/* /var/cache/apk/*

ADD .env /app
ADD package.json /app

COPY --from=node /src/migrations /app/build/migrations
COPY --from=node /src/build /app/build

CMD ["node", "build/src/index.js"]
